# -*- coding: utf-8 -*-
"""Untitled3.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15GAe9KoRFyMqDQap0yCscjXhQJOzLAGU
"""

from transformers import pipeline
import joblib
import numpy as np
import pandas as pd
import gradio as gr

# Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§
model = joblib.load('mymodel.joblib')
sen = pipeline('sentiment-analysis', model='HooshvareLab/bert-fa-base-uncased-sentiment-snappfood')

def process_review(sent, ops, neg, score):
    """
    Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø¸Ø± Ú©Ø§Ø±Ø¨Ø± Ùˆ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª
    """
    # ØªØ­Ù„ÛŒÙ„ Ø§Ø­Ø³Ø§Ø³ Ù…ØªÙ†
    sentf = sen(sent)

    # ØªØ¨Ø¯ÛŒÙ„ Ø§Ø­Ø³Ø§Ø³ Ø¨Ù‡ Ø¹Ø¯Ø¯
    des = 1 if sentf[0]['label'] == 'HAPPY' else 0

    # Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¨Ø§ Ù…Ø¯Ù„
    raw = np.array([[des, ops, neg]])
    x = pd.DataFrame(raw, columns=['des', 'pos', 'neg']) # Changed 'ops' to 'pos' here
    pre = model.predict(x)[0]

    # ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ù†Ù‡Ø§ÛŒÛŒ
    if pre == 1 and score >= 3:
        return "âœ… Ù†Ø¸Ø± Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯", "success"
    elif pre == 1 and score < 3:
        return "âŒ Ù„Ø·ÙØ§ Ø§Ù…ØªÛŒØ§Ø² Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø¯Ù‡ÛŒØ¯. Ù†Ø¸Ø± Ø´Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯.", "error"
    elif pre == 0 and score < 3:
        return "âœ… Ù†Ø¸Ø± Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯", "success"
    elif pre == 0 and score >= 3:
        return "âŒ Ù„Ø·ÙØ§ Ø§Ù…ØªÛŒØ§Ø² Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø¯Ù‡ÛŒØ¯. Ù†Ø¸Ø± Ø´Ù…Ø§ Ø«Ø¨Øª Ù†Ø´Ø¯.", "error"
    else:
        return "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´", "warning"

def get_sentiment_label(text):
    """Ù†Ù…Ø§ÛŒØ´ ØªØ­Ù„ÛŒÙ„ Ø§Ø­Ø³Ø§Ø³ Ù…ØªÙ†"""
    if not text:
        return "Ù…ØªÙ† ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡"

    result = sen(text)
    label = result[0]['label']
    score = result[0]['score']

    if label == 'HAPPY':
        return f"ğŸ˜Š Ù…Ø«Ø¨Øª (Ø§Ø·Ù…ÛŒÙ†Ø§Ù†: {score:.2%})"
    else:
        return f"ğŸ˜ Ù…Ù†ÙÛŒ (Ø§Ø·Ù…ÛŒÙ†Ø§Ù†: {score:.2%})"

# Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø§Ø¨Ø· Gradio
with gr.Blocks(title="ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ù†Ø¸Ø± Ø®Ø±ÛŒØ¯Ø§Ø±", theme=gr.themes.Soft()) as demo:
    gr.Markdown("# ğŸ›ï¸ ÙˆÛŒØ±Ø§ÛŒØ´Ú¯Ø± Ù†Ø¸Ø± Ø®Ø±ÛŒØ¯Ø§Ø±")
    gr.Markdown("Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ú©Ø§Ù„Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ø§Ø¹Ù…Ø§Ù„ Ù†Ù…Ø§ÛŒÛŒØ¯.")

    with gr.Row():
        with gr.Column(scale=2):
            sent = gr.Textbox(
                label="Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø±Ø§Ø¬Ø¨ Ú©Ø§Ù„Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯",
                placeholder="Ù…Ø«Ø§Ù„: Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ Ú©ÛŒÙÛŒØª ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø§Ø±Ø¯...",
                lines=4
            )

            # Ù†Ù…Ø§ÛŒØ´ ØªØ­Ù„ÛŒÙ„ Ø§Ø­Ø³Ø§Ø³ Ø¨Ù‡ ØµÙˆØ±Øª real-time
            sentiment_output = gr.Textbox(
                label="ØªØ­Ù„ÛŒÙ„ Ø§Ø­Ø³Ø§Ø³ Ù…ØªÙ†",
                interactive=False
            )

            sent.change(
                fn=get_sentiment_label,
                inputs=sent,
                outputs=sentiment_output
            )

        with gr.Column(scale=1):
            ops = gr.Slider(
                minimum=0,
                maximum=3,
                value=1,
                step=1,
                label="ØªØ¹Ø¯Ø§Ø¯ Ù†Ù‚Ø§Ø· Ù‚ÙˆØª"
            )

            neg = gr.Slider(
                minimum=0,
                maximum=3,
                value=1,
                step=1,
                label="ØªØ¹Ø¯Ø§Ø¯ Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù"
            )

            score = gr.Radio(
                choices=[1, 2, 3, 4, 5],
                value=3,
                label="Ø§Ù…ØªÛŒØ§Ø² Ú©Ø§Ù„Ø§",
                info="Ø§Ø² Û± ØªØ§ Ûµ Ø§Ù…ØªÛŒØ§Ø² Ø¯Ù‡ÛŒØ¯"
            )

    # Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª
    submit_btn = gr.Button("ğŸ“ Ø«Ø¨Øª Ù†Ø¸Ø±", variant="primary")

    # Ø®Ø±ÙˆØ¬ÛŒâ€ŒÙ‡Ø§
    with gr.Row():
        result_output = gr.Textbox(
            label="Ù†ØªÛŒØ¬Ù‡ Ø«Ø¨Øª Ù†Ø¸Ø±",
            interactive=False
        )

        status_output = gr.Textbox(
            label="ÙˆØ¶Ø¹ÛŒØª",
            interactive=False
        )

    # Ø±ÙˆÛŒØ¯Ø§Ø¯ Ú©Ù„ÛŒÚ©
    submit_btn.click(
        fn=process_review,
        inputs=[sent, ops, neg, score],
        outputs=[result_output, status_output]
    )

    # Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡
    gr.Markdown("### Ù…Ø«Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡")
    examples = [
        ["Ø§ÛŒÙ† Ù…Ø­ØµÙˆÙ„ ÙˆØ§Ù‚Ø¹Ø§ Ø¹Ø§Ù„ÛŒ Ø§Ø³Øª Ùˆ Ú©ÛŒÙÛŒØª ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø§Ø±Ø¯", 2, 1, 5],
        ["Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ† Ùˆ Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¶Ø¹ÛŒÙ", 1, 2, 2],
        ["Ù‚ÛŒÙ…Øª Ù…Ù†Ø§Ø³Ø¨ Ø§Ù…Ø§ Ø¯ÙˆØ§Ù… Ú©Ù…", 2, 2, 3]
    ]

    gr.Examples(
        examples=examples,
        inputs=[sent, ops, neg, score],
        outputs=[result_output, status_output],fn=process_review,
        cache_examples=True
    )

    # Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡
    with gr.Accordion("ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡", open=False):
        gr.Markdown("""
        Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡:
        1. Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ú©Ø§Ù„Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯
        2. ØªØ¹Ø¯Ø§Ø¯ Ù†Ù‚Ø§Ø· Ù‚ÙˆØª Ùˆ Ø¶Ø¹Ù Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯
        3. Ø§Ù…ØªÛŒØ§Ø² Û± ØªØ§ Ûµ Ø¨Ù‡ Ú©Ø§Ù„Ø§ Ø¯Ù‡ÛŒØ¯
        4. Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª Ù†Ø¸Ø± Ø±Ø§ Ø¨ÙØ´Ø§Ø±ÛŒØ¯

        Ù†Ú©Ø§Øª:
        - Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø­Ø³Ø§Ø³ Ù…ØªÙ† Ø±Ø§ ØªØ­Ù„ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        - ØªØ±Ú©ÛŒØ¨ Ø§Ø­Ø³Ø§Ø³ØŒ Ø§Ù…ØªÛŒØ§Ø² Ùˆ Ù†Ù‚Ø§Ø· Ù‚ÙˆØª/Ø¶Ø¹ÙØª ØªØµÙ…ÛŒÙ… Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
        """)
name = 'main'
# Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡
if name == "main":
    demo.launch(
        server_name="0.0.0.0",
        server_port=7861, # Changed port to 7861
        share=True,  # Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ†Ú© Ø¹Ù…ÙˆÙ…ÛŒ True Ú©Ù†ÛŒØ¯
        debug=True
    )